description: Template for launching an OSCAR Virtual Cluster
imports:
- ec3_custom_types: https://raw.githubusercontent.com/grycap/ec3/tosca/tosca/custom_types.yaml
topology_template:
  inputs:
    admin_token:
      default: waulyucwvtzvqpap
      type: string
    cert_user_email:
      default: jhondoe@server.com
      type: string
    cluster_name:
      default: oscar-cluster-llsypjrr
      type: string
    domain_name:
      default: im.grycap.net
      type: string
    fe_cpus:
      default: 2
      type: integer
    fe_mem:
      default: 4 GB
      type: scalar-unit.size
    fe_os_image:
      default: ost://horsemem.i3m.upv.es/c99bc2af-76dd-498f-ba6f-36889db66856
      type: string
    minio_password:
      default: zcjluzqqiobyqafn
      type: string
    oscar_password:
      default: fuiwfmofwjprtdgk
      type: string
    storage_size:
      default: 50 GB
      type: string
  node_templates:
    dns_reg:
      properties:
        dns_service_credentials:
          token: AK:SK
          token_type: password
        domain_name:
          get_input: domain_name
        record_name:
          get_input: cluster_name
      requirements:
      - host: front
      type: tosca.nodes.ec3.DNSRegistry
    dns_reg_console_minio:
      properties:
        dns_service_credentials:
          token: AK:SK
          token_type: password
        domain_name:
          get_input: domain_name
        record_name:
          concat:
          - console.minio.
          - get_input: cluster_name
      requirements:
      - host: front
      type: tosca.nodes.ec3.DNSRegistry
    dns_reg_minio:
      properties:
        dns_service_credentials:
          token: AK:SK
          token_type: password
        domain_name:
          get_input: domain_name
        record_name:
          concat:
          - minio.
          - get_input: cluster_name
      requirements:
      - host: front
      type: tosca.nodes.ec3.DNSRegistry
    front:
      capabilities:
        endpoint:
          properties:
            dns_name: kubeserver
            network_name: PUBLIC
        host:
          properties:
            mem_size:
              get_input: fe_mem
            num_cpus:
              get_input: fe_cpus
        os:
          properties:
            image:
              get_input: fe_os_image
            type: linux
      requirements:
      - local_storage:
          capability: tosca.capabilities.Attachment
          node: my_block_storage
          relationship:
            properties:
              device: hdb
              location: /pv
            type: tosca.relationships.AttachesTo
      type: tosca.nodes.indigo.Compute
    lrms_front_end:
      capabilities:
        endpoint:
          properties:
            port: 30443
            protocol: tcp
      properties:
        admin_token:
          get_input: admin_token
        admin_username: kubeuser
        cert_manager: true
        cert_manager_challenge: dns01
        cert_manager_challenge_dns01_ak: AK
        cert_manager_challenge_dns01_domain:
          get_property:
          - dns_reg
          - domain_name
        cert_manager_challenge_dns01_sk: SK
        cert_user_email:
          get_input: cert_user_email
        install_ingress: true
        install_kubeapps: false
        install_metrics: true
        install_nfs_client: true
        public_dns_name:
          concat:
          - get_property:
            - dns_reg
            - record_name
          - .
          - get_property:
            - dns_reg
            - domain_name
        version: 1.23.6
      requirements:
      - host: front
      type: tosca.nodes.indigo.LRMS.FrontEnd.Kubernetes
    my_block_storage:
      properties:
        size:
          get_input: storage_size
      type: tosca.nodes.BlockStorage
    oscar:
      capabilities:
        endpoint:
          properties:
            ports:
              http_port:
                protocol: tcp
                source: 80
              https_port:
                protocol: tcp
                source: 443
              minio_port:
                protocol: tcp
                source: 30300
      properties:
        dns_host:
          concat:
          - get_property:
            - dns_reg
            - record_name
          - .
          - get_property:
            - dns_reg
            - domain_name
        minio_dns_host:
          concat:
          - minio.
          - get_property:
            - dns_reg
            - record_name
          - .
          - get_property:
            - dns_reg
            - domain_name
        minio_dns_host_console:
          concat:
          - console.minio.
          - get_property:
            - dns_reg
            - record_name
          - .
          - get_property:
            - dns_reg
            - domain_name
        minio_secretkey:
          get_input: minio_password
        password:
          get_input: oscar_password
      requirements:
      - host: lrms_front_end
      type: tosca.nodes.indigo.OSCAR
    wn:
      capabilities:
        host:
          properties:
            mem_size:
              get_input: wn_mem
            num_cpus:
              get_input: wn_cpus
            preemtible_instance:
              get_input: wn_preemtible_instance
            sgx:
              get_input: wn_sgx
        os:
          properties:
            distribution:
              get_input: os_distribution
            image:
              get_input: os_image
            type:
              get_input: os_type
            version:
              get_input: os_version
        scalable:
          properties:
            count:
              get_input: wn_num
      type: tosca.nodes.indigo.Compute
    wn_mask-detector_container1:
      capabilities:
        host:
          properties:
            mem_size: 8192 MB
            num_cpus: 4
            num_gpus: 0
            preemtible_instance: false
            sgx: false
        os:
          properties:
            distribution: Ubuntu
            image: ost://horsemem.i3m.upv.es/c99bc2af-76dd-498f-ba6f-36889db66856
            type: linux
            version: 20.04
        scalable:
          properties:
            count: 5
      type: tosca.nodes.indigo.Compute
    wn_node:
      properties:
        front_end_ip:
          get_attribute:
          - front
          - private_address
          - 0
        version: 1.23.6
      requirements:
      - host: wn
      type: tosca.nodes.indigo.LRMS.WorkerNode.Kubernetes
    wn_node_mask-detector_container1:
      properties:
        front_end_ip:
          get_attribute:
          - front
          - private_address
          - 0
        version: 1.23.6
      requirements:
      - host: wn_mask-detector_container1
      type: tosca.nodes.indigo.LRMS.WorkerNode.Kubernetes
  outputs:
    admin_token:
      value:
        get_input: admin_token
    console_minio_endpoint:
      value:
        concat:
        - https://
        - get_property:
          - dns_reg_console_minio
          - record_name
        - .
        - get_property:
          - dns_reg_console_minio
          - domain_name
        - /
    dashboard_endpoint:
      value:
        concat:
        - https://
        - get_property:
          - dns_reg
          - record_name
        - .
        - get_property:
          - dns_reg
          - domain_name
        - /dashboard/
    fe_node_creds:
      value:
        get_attribute:
        - front
        - endpoint
        - credential
        - 0
    fe_node_ip:
      value:
        get_attribute:
        - front
        - public_address
        - 0
    minio_endpoint:
      value:
        concat:
        - https://
        - get_property:
          - dns_reg_minio
          - record_name
        - .
        - get_property:
          - dns_reg_minio
          - domain_name
        - /
    minio_password:
      value:
        get_input: minio_password
    oscar_password:
      value:
        get_input: oscar_password
    oscarui_endpoint:
      value:
        concat:
        - https://
        - get_property:
          - dns_reg
          - record_name
        - .
        - get_property:
          - dns_reg
          - domain_name
        - /
tosca_definitions_version: tosca_simple_yaml_1_0
